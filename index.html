<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>siraa weather app</title>
<style>
    /* This CSS is fully self-contained and error-free */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-size: cover; background-position: center; background-attachment: fixed;
        color: white; display: flex; justify-content: center; align-items: center;
        min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box;
        transition: background-image 1s ease-in-out;
    }
    .weather-container {
        background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px);
        border-radius: 15px; padding: 25px; border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4); max-width: 500px; width: 100%;
    }
    .search-controls { display: flex; align-items: center; gap: 10px; position: relative; }
    .search-controls input[type="text"] { flex-grow: 1; }
    input[type="text"], input[type="date"] {
        padding: 12px; font-size: 1rem; border-radius: 5px;
        border: 1px solid #7f8c8d; background-color: rgba(0, 0, 0, 0.4); color: white;
    }
    input::placeholder { color: #bdc3c7; }
    button {
        padding: 12px 18px; font-size: 1rem; cursor: pointer;
        background-color: #3498db; color: white; border: none; border-radius: 5px;
    }
    #get-location-btn { padding: 12px 14px; }
    button:disabled { background-color: #555; cursor: not-allowed; }
    #suggestions-box {
        position: absolute; background-color: #2c3e50; border: 1px solid #7f8c8d;
        width: 100%; max-height: 200px; overflow-y: auto;
        z-index: 1000; border-radius: 5px; top: 48px; left: 0;
    }
    .suggestion-item { padding: 12px 15px; cursor: pointer; color: #ecf0f1; border-bottom: 1px solid #34495e; }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:hover { background-color: #3498db; }
    #hourly-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-top: 10px; }
    .hourly-item { background-color: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 8px; text-align: center; font-size: 0.9rem; }
    .icon-placeholder { font-size: 3rem; margin-right: 15px; width: 50px; text-align: center; }
    .hidden { display: none; }
    #error-msg { color: #e74c3c; background-color: rgba(231, 76, 60, 0.2); padding: 10px; border-radius: 5px; margin-top: 10px; display: none; text-align: center; }
    .weather-header { display: flex; align-items: center; margin-top: 15px; }
    #display-temp { font-weight: bold; font-size: 3rem; }
    h1 { margin-top: 0; text-align: center; }
    #map-container { margin-top: 20px; }
    #google-map-iframe { height: 250px; width: 100%; border-radius: 10px; border: 2px solid rgba(255, 255, 255, 0.2); }
    #risk-indicator { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid; }
    #risk-level { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }
    .risk-low { background-color: rgba(46, 204, 113, 0.2); border-color: #2ecc71; }
    .risk-moderate { background-color: rgba(241, 196, 15, 0.2); border-color: #f1c40f; }
    .risk-high { background-color: rgba(230, 126, 34, 0.2); border-color: #e67e22; }
    .risk-extreme { background-color: rgba(192, 57, 43, 0.3); border-color: #c0392b; }
</style>
</head>
<body>

<div class="weather-container">
    <h1>siraa weather app</h1>
    <div class="search-controls">
      <input id="city-input" type="text" placeholder="Search any city, place, or rural area..." autocomplete="off" />
      <div id="suggestions-box" class="hidden"></div>
    </div>
    <div class="search-controls" style="margin-top: 10px;">
        <input id="date-input" type="date" />
        <button id="get-location-btn" title="Use my location">🎯</button>
        <button id="search-btn">Get Weather</button>
    </div>
    <div id="error-msg"></div>
    <div id="results-container" class="hidden">
        <h2 class="city-name">Weather</h2>
        <div id="display-date"></div>
        <div class="weather-header">
          <span id="weather-icon" class="icon-placeholder"></span>
          <span id="display-temp">--°C</span>
        </div>
        <div id="display-desc" style="font-size: 1.2rem; margin-top: 5px;">---</div>
        <div id="details-grid" class="hidden" style="margin-top:20px; display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div><strong>Wind Speed:</strong> <span id="wind-speed"></span></div>
          <div><strong>Humidity:</strong> <span id="humidity"></span></div>
          <div><strong>Feels Like:</strong> <span id="feels-like"></span></div>
        </div>
        <div id="risk-indicator" class="hidden">
            <div id="risk-level"></div>
            <div id="risk-description"></div>
        </div>
        <button id="hourly-toggle" style="display:none; margin-top: 20px;">Show Hourly Weather ▼</button>
        <div id="hourly-container" style="display:none;"></div>
        <div id="map-container" class="hidden">
            <h3 style="margin-bottom: 10px;">Location Map</h3>
            <iframe id="google-map-iframe" loading="lazy" allowfullscreen></iframe>
        </div>
    </div>
</div>

<script>
(() => {
  // --- Dynamic Background ---
  const backgrounds = [
      'https://images.unsplash.com/photo-1534202888314-78328ade38b8?q=80&w=1932&auto=format&fit=crop',
      'https://images.unsplash.com/photo-1534794048419-48321352c368?q=80&w=1935&auto=format&fit=crop',
      'https://images.unsplash.com/photo-1592210454359-9043f067919b?q=80&w=2070&auto=format&fit=crop',
      'https://images.unsplash.com/photo-1444703686981-a3abbc4d423f?q=80&w=2070&auto=format&fit=crop'
  ];
  document.body.style.backgroundImage = linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('${backgrounds[Math.floor(Math.random()*backgrounds.length)]}');

  // --- Element References ---
  const cityInput = document.getElementById('city-input');
  const dateInput = document.getElementById('date-input');
  const searchBtn = document.getElementById('search-btn');
  const getLocationBtn = document.getElementById('get-location-btn');
  const resultsContainer = document.getElementById('results-container');
  const cityNameEl = document.querySelector('.city-name');
  const displayDateEl = document.getElementById('display-date');
  const displayTempEl = document.getElementById('display-temp');
  const displayDescEl = document.getElementById('display-desc');
  const detailsGridEl = document.getElementById('details-grid');
  const errorMsgEl = document.getElementById('error-msg');
  const windSpeedEl = document.getElementById('wind-speed');
  const humidityEl = document.getElementById('humidity');
  const feelsLikeEl = document.getElementById('feels-like');
  const iconEl = document.getElementById('weather-icon');
  const hourlyToggleBtn = document.getElementById('hourly-toggle');
  const hourlyContainer = document.getElementById('hourly-container');
  const riskIndicator = document.getElementById('risk-indicator');
  const riskLevelEl = document.getElementById('risk-level');
  const riskDescriptionEl = document.getElementById('risk-description');
  const mapContainer = document.getElementById('map-container');
  const googleMapIframe = document.getElementById('google-map-iframe');
  const suggestionsBox = document.getElementById('suggestions-box');
  
  const WEATHER_API_KEY = 'baafbbbcca324f6487962853250410';
  let selectedCoordinates = null; // Stores lat,lon for the selected place

  // --- NEW: Debounce function to prevent API calls on every keystroke ---
  function debounce(func, delay) {
      let timeout;
      return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
      };
  }
  
  // --- Autocomplete search using WeatherAPI ---
  async function fetchCitySuggestions(query) {
    if (!query || query.length < 3) {
      suggestionsBox.classList.add('hidden');
      return;
    }
    try {
      const url = https://api.weatherapi.com/v1/search.json?key=${WEATHER_API_KEY}&q=${encodeURIComponent(query)};
      const response = await fetch(url);
      if (!response.ok) return;

      const cities = await response.json();
      suggestionsBox.innerHTML = '';
      if (cities.length > 0) {
        cities.forEach(city => {
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          item.textContent = ${city.name}, ${city.country};
          item.addEventListener('click', () => {
            cityInput.value = ${city.name}, ${city.country};
            selectedCoordinates = ${city.lat},${city.lon}; // Store coordinates
            suggestionsBox.classList.add('hidden');
          });
          suggestionsBox.appendChild(item);
        });
        suggestionsBox.classList.remove('hidden');
      } else {
        suggestionsBox.classList.add('hidden');
      }
    } catch (error) {
      console.error('City suggestion error:', error);
      suggestionsBox.classList.add('hidden');
    }
  }

  function updateMap(query) {
      const encodedQuery = encodeURIComponent(query);
      const mapUrl = https://maps.google.com/maps?q=${encodedQuery}&t=k&z=10&ie=UTF8&iwloc=&output=embed;
      googleMapIframe.src = mapUrl;
      mapContainer.classList.remove('hidden');
  }

  function calculateRiskLevel(data) {
    let score = 0, reasons = [];
    if (data.wind > 10) { score += 1; reasons.push("Strong winds."); }
    if (data.wind > 17) { score += 2; reasons.push("High winds."); }
    if (data.temp > 35) { score += 2; reasons.push("Extreme heat."); }
    if (data.temp < -5) { score += 1; reasons.push("Freezing temperatures."); }
    const desc = data.desc.toLowerCase();
    if (desc.includes('thunder')) { score += 3; reasons.push("Risk of thunderstorms."); }
    if (desc.includes('snow') || desc.includes('blizzard')) { score += 2; reasons.push("Snow or ice."); }
    if (desc.includes('heavy rain')) { score += 2; reasons.push("Heavy rain."); }
    
    let level, description, cssClass;
    if (score >= 6) { level = "EXTREME"; cssClass = "risk-extreme"; }
    else if (score >= 4) { level = "HIGH"; cssClass = "risk-high"; }
    else if (score >= 2) { level = "MODERATE"; cssClass = "risk-moderate"; }
    else { level = "LOW"; cssClass = "risk-low"; }
    description = (reasons.length > 0) ? reasons.join(" ") : "Conditions are calm.";
    
    riskLevelEl.textContent = Risk Level: ${level};
    riskDescriptionEl.textContent = description;
    riskIndicator.className = cssClass;
    riskIndicator.classList.remove('hidden');
  }

  function getWeatherIcon(d) {
    d = d.toLowerCase();
    if (d.includes('clear') || d.includes('sunny')) return '☀';
    if (d.includes('cloud') || d.includes('overcast')) return '☁';
    if (d.includes('rain') || d.includes('drizzle')) return '🌧';
    if (d.includes('snow') || d.includes('sleet')) return '❄';
    if (d.includes('thunder')) return '⚡';
    if (d.includes('fog') || d.includes('mist')) return '🌫';
    return '⛅';
  }

  function updateWeatherDisplay(data) {
    resultsContainer.classList.remove('hidden');
    cityNameEl.textContent = data.name;
    displayDateEl.textContent = data.dateString;
    displayTempEl.textContent = ${Math.round(data.temp)}°C;
    displayDescEl.textContent = data.desc;
    iconEl.textContent = getWeatherIcon(data.desc);
    windSpeedEl.textContent = ${data.wind.toFixed(1)} m/s;
    humidityEl.textContent = ${data.humidity}%;
    feelsLikeEl.textContent = ${Math.round(data.feels)}°C;
    detailsGridEl.classList.remove('hidden');
    
    updateMap(data.query);
    calculateRiskLevel(data);

    if (data.hourly && data.hourly.length > 0) {
      hourlyToggleBtn.style.display = 'block';
      hourlyToggleBtn.textContent = 'Show Hourly Weather ▼';
      hourlyContainer.style.display = 'none';
      hourlyContainer.innerHTML = '';
      data.hourly.forEach(hour => {
        const hourEl = document.createElement('div');
        hourEl.className = 'hourly-item';
        hourEl.innerHTML = <div><strong>${new Date(hour.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</strong></div><div style="font-size: 1.5rem;">${getWeatherIcon(hour.condition.text)}</div><div>${Math.round(hour.temp_c)}°C</div>;
        hourlyContainer.appendChild(hourEl);
      });
    } else {
      hourlyToggleBtn.style.display = 'none';
    }
  }

  hourlyToggleBtn.addEventListener('click', () => {
    const isHidden = hourlyContainer.style.display === 'none';
    hourlyContainer.style.display = isHidden ? 'grid' : 'none';
    hourlyToggleBtn.textContent = isHidden ? 'Hide Hourly Weather ▲' : 'Show Hourly Weather ▼';
  });
  
  searchBtn.addEventListener('click', () => {
    const locationQuery = selectedCoordinates || cityInput.value;
    const date = dateInput.value;
    if (locationQuery && date) {
        fetchWeatherData(locationQuery, date);
    } else {
        errorMsgEl.textContent = 'Please select a location and a date.';
        errorMsgEl.style.display = 'block';
    }
  });

  async function fetchWeatherData(query, date) {
    errorMsgEl.style.display = 'none';
    resultsContainer.classList.add('hidden');
    cityNameEl.textContent = 'Searching...';
    iconEl.textContent = '⏳';
    searchBtn.disabled = true;
    getLocationBtn.disabled = true;

    const todayStr = new Date().toISOString().split('T')[0];
    const apiUrl = https://api.weatherapi.com/v1/${date >= todayStr ? 'forecast' : 'history'}.json?key=${WEATHER_API_KEY}&q=${encodeURIComponent(query)}&dt=${date};

    try {
      const response = await fetch(apiUrl);
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error.message || HTTP error: ${response.status});
      }
      const data = await response.json();
      if (!data.location || !data.forecast) throw new Error('No weather data found for this location.');

      const dayData = data.forecast.forecastday[0].day;
      const weatherData = {
        name: ${data.location.name}, ${data.location.country},
        dateString: new Date(data.forecast.forecastday[0].date + 'T00:00:00').toDateString(),
        temp: dayData.avgtemp_c, desc: dayData.condition.text,
        wind: dayData.maxwind_kph * 0.27778, humidity: dayData.avghumidity,
        feels: dayData.maxtemp_c, hourly: data.forecast.forecastday[0].hour || [],
        query: ${data.location.lat},${data.location.lon}
      };
      updateWeatherDisplay(weatherData);
    } catch (error) {
      errorMsgEl.textContent = Error: ${error.message};
      errorMsgEl.style.display = 'block';
    } finally {
      searchBtn.disabled = false;
      getLocationBtn.disabled = false;
    }
  }

  getLocationBtn.addEventListener('click', () => {
    if (!navigator.geolocation) {
        errorMsgEl.textContent = "Geolocation is not supported by your browser.";
        errorMsgEl.style.display = 'block';
        return;
    }
    cityNameEl.textContent = "Getting location...";
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const locationQuery = ${position.coords.latitude},${position.coords.longitude};
        cityInput.value = "Current Location";
        selectedCoordinates = locationQuery;
        fetchWeatherData(locationQuery, dateInput.value);
      },
      () => {
        errorMsgEl.textContent = "Unable to retrieve location. Please grant permission.";
        errorMsgEl.style.display = 'block';
      }
    );
  });
  
  cityInput.addEventListener('input', debounce(() => fetchCitySuggestions(cityInput.value), 300));
  
  document.addEventListener('click', (event) => {
    if (!cityInput.contains(event.target)) {
        suggestionsBox.classList.add('hidden');
    }
  });
  
  dateInput.value = new Date().toISOString().split('T')[0];
})();
</script>
</body>
</html>